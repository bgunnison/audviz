<!DOCTYPE html>
<!--
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Author: Eric Bidelman (ericbidelman@chromium.org)

modified heavily by Brian Gunnison (briang@tekelite.com)
-->
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <title>Gunnison</title>
    <link href="../css/audioplayer.css" rel="stylesheet" type="text/css">

    <script src="../javascript/spinners.js"></script>
    <script src="../javascript/dat.gui.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
    <script src="../javascript/jquery.knob.js"></script>
    <script src="../javascript/aud_viz.js"></script>
    <script>
    $(function($) {

        $(".knob").knob({
            change : function (value) {
                //console.log("change : " + value);
            },
            release : function (value) {
                //console.log(this.$.attr('value'));
                console.log("release : " + value);
            },
            cancel : function () {
                console.log("cancel : ", this);
            },
            draw : function () {

                // "tron" case
                if(this.$.data('skin') == 'tron') {

                    var a = this.angle(this.cv)  // Angle
                            , sa = this.startAngle          // Previous start angle
                            , sat = this.startAngle         // Start angle
                            , ea                            // Previous end angle
                            , eat = sat + a                 // End angle
                            , r = 1;

                    this.g.lineWidth = this.lineWidth;

                    this.o.cursor
                            && (sat = eat - 0.3)
                    && (eat = eat + 0.3);

                    if (this.o.displayPrevious) {
                        ea = this.startAngle + this.angle(this.v);
                        this.o.cursor
                                && (sa = ea - 0.3)
                        && (ea = ea + 0.3);
                        this.g.beginPath();
                        this.g.strokeStyle = this.pColor;
                        this.g.arc(this.xy, this.xy, this.radius - this.lineWidth, sa, ea, false);
                        this.g.stroke();
                    }

                    this.g.beginPath();
                    this.g.strokeStyle = r ? this.o.fgColor : this.fgColor ;
                    this.g.arc(this.xy, this.xy, this.radius - this.lineWidth, sat, eat, false);
                    this.g.stroke();

                    this.g.lineWidth = 2;
                    this.g.beginPath();
                    this.g.strokeStyle = this.o.fgColor;
                    this.g.arc( this.xy, this.xy, this.radius - this.lineWidth + 1 + this.lineWidth * 2 / 3, 0, 2 * Math.PI, false);
                    this.g.stroke();

                    return false;
                }
            }
        });
    });
        </script>
</head>
<body>

<div>
    <input class="knob" data-width="80%" value="35" style="position: absolute; left: 1em; top: 3em; z-index: 1;">
</div>

<section>
    <div>
        <canvas id="viz_canvas" class="viz_canvas" width="512" height="400"> </canvas>
    </div>
</section>


<script>

(function() {

var audioContext = null;

// Check for non Web Audio API browsers.

    try {
        // Fix up for prefixing
        window.AudioContext = window.AudioContext||window.webkitAudioContext;
        audioContext = new AudioContext();
    }
    catch(e) {
        alert('Web Audio API is not supported in this browser');
        return;
    }

    var canvas = document.getElementById('viz_canvas');
    var canvasCtx = canvas.getContext('2d');
    canvas.width = document.body.clientWidth / 1.4;
    canvas.style.border = "#D0D0D0 3px solid";
    //canvas.style.borderRadius = "15px"; //only rounds shadow
    canvas.style.boxShadow = "3px 5px 3px #A0A0A0";
    var canvasBackgroundColor = "#000000";
    canvas.fillStyle =  canvasBackgroundColor;
    canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
    var spinner = null;
    var logMsgs = [];

    canvasLog("Canvas created");
    function canvasShowLog() {
        canvasCtx.font = "10pt Arial Bold";
        canvasCtx.fillStyle = "#A0A0A0"
        var yPos = 10;
        for (var i = 0; i < logMsgs.length; i++)  {
            canvasCtx.fillText(logMsgs[i],10, yPos);
            yPos += 10;
        }
    }
    function canvasLog(msg) {
        logMsgs.push(msg);
        console.log(msg);
        canvasShowLog();
    }

    window.onresize = function() {
        canvas.width = document.body.clientWidth/1.4;
        //canvas.height = document.body.clientHeight;
    };

    /*
    // http://learningthreejs.com/blog/2011/08/14/dat-gui-simple-ui-for-demos/
    var obj = { x: 5 };
    var guiConfig = {autoPlace: false, };      // place it
                    // height : 5 * 32 - 1 }; //5 lines
    var gui = new dat.GUI(guiConfig );
    //var gui = new dat.GUI();
    gui.add(obj, 'x');
    var customContainer = document.getElementById('audvizgui');
    customContainer.appendChild(gui.domElement);
*/
    var touchstart = 'mousedown';
    var touchmove = 'mousemove';
    var touchend = 'mouseup';

    var soundBuffer = null;
    var playControls = new PlayControls(canvasCtx);
    audioState = "init";
    var audioSource = null;
    var spinner = null;
    var playTime = 0;
    var pauseTime = 0;

    canvas.addEventListener(touchstart, function(e) {
        function handle(x, y, touch) {

        }

        if(e.changedTouches) {
            for(var i=0; i<e.changedTouches.length; i++) {
                var touch = e.changedTouches[i];
                handle(touch.pageX, touch.pageY, touch);
            }
        }
        else {
            mouseDown = true;
            handle(e.pageX, e.pageY);

            if (audioSource != null) {
                switch (audioState) {
                    case "connected":
                        // unlocks web audio for iOS
                        audioSource.start(0, pauseTime);
                        audioState = "playing";

                        playTime = audioContext.currentTime;
                        canvasLog("Play started: " + playTime);
                        break;

                    case "playing":
                        // ramp down volume

                        audioState = "paused";
                        break;

                    case "paused":
                        // ramp up volume

                        audioState = "playing";
                        break;

                    default:
                        canvasLog("Unknown play state");
                        break;

                }
            }
            else {
                canvasLog("audioSource is null");
            }

        }
    });

    function AudioConnect(buffer) {
        if (buffer == null) {
            canvasLog("decode buffer is null");
            return;
        }

        audioSource = audioContext.createBufferSource();
        audioSource.buffer = buffer;
        canvasLog("Audio decoded");
        audioState = "decoded";

        audioSource.connect(analyser);
        audioSource.connect(stereo);
        stereo.connect(leftAnal,0);
        stereo.connect(rightAnal,1);
        audioSource.connect(audioContext.destination);
        canvasLog("Audio connected");
        audioState = "connected";
        stopSpinner(spinner);

        rafCallback();
        canvasLog("Animation started");
    }

    function AudioDecode() {
        if (soundBuffer == null) {
            canvasLog("sound buffer is null");
            return;
        }

        audioContext.decodeAudioData(soundBuffer, AudioConnect);
        audioState = "decoding";
    }

    function AudioLoaded(arrayBuffer) {
        audioState = "loaded";

        soundBuffer = arrayBuffer;
        AudioDecode();
    }

    function updateAudFileDownloadProgress(evt)
    {
        if (evt.lengthComputable)
        {  //evt.loaded the bytes browser receive
            //evt.total the total bytes seted by the header
            // we will get the total once we implenment the JSON file info transaction
            //var percentComplete = (evt.loaded / evt.total)*100;
            console.log(evt.loaded)
        }
    }


    function AudioLoad() {
        var request = new XMLHttpRequest();
        request.onprogress=updateAudFileDownloadProgress;
        var url = localStorage.getItem("audToPlay");
        request.open('GET', url, true);
        request.responseType = 'arraybuffer';
        request.onload = function(e) {
            AudioLoaded(request.response);
        };

        spinner = startSpinner(canvasCtx);

        request.onerror = function() {
            // if there is an error, switch the sound to HTML Audio
            canvasLog("Audio request error");
        };
        try {
            request.send();
        } catch (e) {
            request.onerror();
        }

        canvasLog("Audio request sent");
    };


   // var audioContext = new webkitAudioContext();
    var analyser = audioContext.createAnalyser();
    analyser.DefaultSmoothingTimeConstant = 0.3;
    analyser.minDecibels = -120;
    var stereo = audioContext.createChannelSplitter(2);
    var leftAnal = audioContext.createAnalyser();
    var rightAnal = audioContext.createAnalyser();
    leftAnal.minDecibels = rightAnal.minDecibels = analyser.minDecibels;
    canvasLog("AudioContext created");
    //console.log(leftAnal.frequencyBinCount)
    //console.log(analyser.maxDecibels);
    //console.log(analyser.minDecibels);
    console.log("Canvas width: ", + canvas.width)


    function rafCallback(time) {
        window.webkitRequestAnimationFrame(rafCallback, canvas);

        canvasCtx.fillStyle = canvasBackgroundColor;
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

        if (audioState != 'playing') {
            playControls.drawPlayButton();
            canvasShowLog();
            return;
        }

        // currently the sample rate is set by the audio card, it can be really high 192,000 for example
        DisplaySpectrum(canvasCtx, analyser, audioContext.sampleRate);

        DisplayLissajous(canvasCtx, leftAnal, rightAnal);

        canvasShowLog();
    }

    function onLoad(e) {
        canvasLog("Page loaded");
        // make canvas appear
        $(".viz_canvas").toggleClass("viz_canvas_appear");
        // Note: the audio graph must be connected after the page is loaded.
        // Otherwise, the Audio tag just plays normally and ignores the audio
        // context. More info: crbug.com/112368
        AudioLoad();
    }

    window.addEventListener('load', onLoad, false);
})();

</script>
</body>
</html>
